name: Socket Server CI (docker-compose)

on:
  workflow_dispatch:
  push:
    paths:
      - 'docker/**'
      - 'node/socket-server/**'
      - 'src/**'

jobs:
  compose:
    runs-on: ubuntu-latest
    env:
      APP_BASE_PATH: /Virtual_Wardrobe
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Docker login
        uses: docker/login-action@v3
      - name: Start docker-compose stack
        run: |
          docker-compose -f docker-compose.yml -f docker-compose.override.yml up -d --build
      - name: Wait for health
        run: |
          for i in {1..30}; do
             if curl -s http://localhost:3001/health >/dev/null 2>&1; then echo 'server ready'; break; fi
             echo 'waiting for health...'; sleep 2
          done
      - name: Run seed
        run: |
          docker exec -u www-data vw-php php src/admin/seed_sample.php || true
      - name: Run Node Tests
        working-directory: node/socket-server
        env:
          SOCKET_SERVER_URL: http://localhost:3001
          SOCKET_API_KEY: ${{ secrets.SOCKET_API_KEY }}
          SOCKET_JWT_SECRET: ${{ secrets.SOCKET_JWT_SECRET }}
          SOCKET_REDIS_URL: redis://redis:6379
          SOCKET_REDIS_PASSWORD: ${{ secrets.SOCKET_REDIS_PASSWORD }}
        run: |
          npm ci
          npm run test-emit -- --user 1 --event planner_update --msg 'docker-compose ci test'
      - name: Run Playwright tests
        working-directory: node/socket-server
        env:
          SOCKET_SERVER_URL: http://localhost:3001
          SOCKET_API_KEY: ${{ secrets.SOCKET_API_KEY }}
          SOCKET_JWT_SECRET: ${{ secrets.SOCKET_JWT_SECRET }}
          APP_URL: http://localhost:8080/Virtual_Wardrobe
          SOCKET_REDIS_URL: redis://redis:6379
          SOCKET_REDIS_PASSWORD: ${{ secrets.SOCKET_REDIS_PASSWORD }}
        run: |
          npm ci
          npx playwright install --with-deps
          npm run test-e2e -- --reporter=junit
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-junit-reports
          path: node/socket-server/test-results
      - name: Tear down
        if: always()
        run: docker-compose down --volumes --remove-orphans
